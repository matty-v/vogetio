version: 2.1

orbs:
  node: circleci/node@4.7.0

commands:
  gcloud-authenticate:
    description: Authenticates to Google Cloud and Google Container Registry
    steps:
      - run:
          name: Authenticate with cloud
          command: |
            # install Google Cloud SDK distribution
            curl -O https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-365.0.1-linux-x86.tar.gz
            ./google-cloud-sdk/install.sh
            ./google-cloud-sdk/bin/gcloud init

            unzip -P $GCP_DECRYPTION_PASSWORD .circleci/gcp-svc-acct.zip
            gcloud auth activate-service-account --key-file=kinetic-object-322814-7a336f8de0fa.json

  docker-build-and-push:
    parameters:
      component-name:
        type: string
        description: Name of the component to build and push
    steps:
      - run:
          name: "Build Image"
          command: |
            cd <<parameters.component-name>>
            docker build -t vogetio-<<parameters.component-name>>:latest -f Dockerfile .
      - run:
          name: "Tage and Push Image to GCR"
          command: |
            docker tag vogetio-<<parameters.component-name>>:latest gcr.io/kinetic-object-322814/vogetio-<<parameters.component-name>>
            docker push gcr.io/kinetic-object-322814/vogetio-<<parameters.component-name>>

jobs:
  build-and-push:
    parameters:
      component-name:
        type: string
        description: Name of the component to build and push
    docker:
      - image: cimg/base:stable
    steps:
      - setup_remote_docker
      - checkout
      - node/install
      - gcloud-authenticate
      - docker-build-and-push:
          component-name: <<parameters.component-name>>

workflows:
  default:
    jobs:
      - build-and-push:
          name: build-and-push-app
          component-name: app
          filters:
            branches:
              only:
                - master
      - build-and-push:
          name: build-and-push-server
          component-name: server
          filters:
            branches:
              only:
                - master
