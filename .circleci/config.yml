version: 2.1

orbs:
  node: circleci/node@4.7.0

commands:
  gcloud-auth:
    description: Authenticates with Google Cloud SDK
    steps:
      - run:
          name: Authenticate with Google Cloud SDK
          command: |
            apt-get update && apt-get install -y unzip
            unzip -P $GCP_DECRYPTION_PASSWORD .circleci/gcp-svc-acct.zip
            gcloud auth activate-service-account --key-file=kinetic-object-322814-7a336f8de0fa.json --project=kinetic-object-322814
            gcloud -q auth configure-docker

jobs:
  build-and-push-server-image:
    docker:
      - image: google/cloud-sdk
    steps:
      - setup_remote_docker
      - checkout
      - gcloud-auth
      - run:
          name: "Build and Push Server Image"
          command: |
            GIT_COMMIT="$(git rev-parse --short HEAD)"
            cd server
            docker build -t gcr.io/kinetic-object-322814/vogetio-server:$GIT_COMMIT -f Dockerfile .
            docker push gcr.io/kinetic-object-322814/vogetio-server:$GIT_COMMIT

  build-and-deploy-app-to-bucket:
    docker:
      - image: google/cloud-sdk
    steps:
      - checkout
      - gcloud-auth
      - node/install
      - run:
          name: Deploy App to Bucket
          command: |
            cd app

            # Webpack build
            npm install webpack@5.64.4 -g
            npm ci --silent
            npm run build-prod

            # Upload to bucket
            gsutil cp dist/* gs://vogetio-app/

  deploy-server-to-cloud-run:
    docker:
      - image: google/cloud-sdk
    steps:
      - checkout
      - gcloud-auth
      - run:
          name: Deploy Server to Cloud Run
          command: |
            GIT_COMMIT="$(git rev-parse --short HEAD)"

            gcloud run deploy vogetio-server --image=gcr.io/kinetic-object-322814/vogetio-server:$GIT_COMMIT --project=kinetic-object-322814 --region=us-central1

workflows:
  default:
    jobs:
      - build-and-deploy-app-to-bucket:
          filters:
            branches:
              only:
                - master
      - build-and-push-server-image:
          filters:
            branches:
              only:
                - master
      - deploy-server-to-cloud-run:
          requires:
            - build-and-push-server-image
          filters:
            branches:
              only:
                - master
